# ACL4SSR Online Full WithIcon - Mihomo 模板化配置
# 功能等效于: https://cdn.jsdelivr.net/gh/mihomo-party-org/override-hub@main/yaml/ACL4SSR_Online_Full_WithIcon.yaml
# 架构参考: config-mihomo.yaml.example

# region YAML 锚点（可复用模板）
# ============================================================
# YAML 锚点（可复用模板）- 集中管理
# ============================================================

# ------------------------------------------------------------\n# 扩展：节点筛选关键词定义
# x- 前缀表示用户自定义扩展（非 Mihomo 原生配置）
#
# 配合 Sub-Store node-renamer.js 使用
# 节点格式: {countryCode} {index:2d} {iplc} {otherTags}
# 示例: HK 01, TW 02 IPLC, JP 03 Home, US 01 IPLC ATT
# ------------------------------------------------------------
x-keywords:
  hong-kong: &HONG_KONG_KEYWORDS "HK"
  taiwan: &TAIWAN_KEYWORDS "TW"
  japan: &JAPAN_KEYWORDS "JP"
  united-states: &UNITED_STATES_KEYWORDS "US"
  singapore: &SINGAPORE_KEYWORDS "SG"
  iplc: &IPLC_KEYWORDS "IPLC"
  game: &GAME_KEYWORDS "Game"
  # 其他地区排除：仅排除主要地区和特殊用途节点
  other-regions-exclude: &OTHER_REGIONS_EXCLUDE_KEYWORDS "HK|TW|JP|US|SG|IPLC|Game"

# ------------------------------------------------------------\n# 扩展：代理组模板定义
# x- 前缀表示用户自定义扩展（非 Mihomo 原生配置）
# ------------------------------------------------------------
x-templates:
  # 代理组基础模板
  proxy-group: &PROXY_GROUP_BASE
    type: select
    interval: 120
    lazy: true
    include-all: true
    exclude-type: direct
    hidden: false
    tolerance: 20
    disable-udp: false
    timeout: 500

  # Fallback 组模板（自动故障转移）
  fallback-group: &FALLBACK_GROUP_BASE
    <<: *PROXY_GROUP_BASE
    type: fallback
    fallback-filter:
      retry: 2
      timeout: 500
      health-check:
        enable: true
        interval: 120
        unhealthy_threshold: 2
        healthy_threshold: 2
        dns:
          - "https://8.8.8.8/dns-query"
          - "https://dns.alidns.com/dns-query"
        http:
          - url: "https://www.gstatic.com/generate_204"
            method: GET
            expected-status: 204
            timeout: 500

  # URL Test 组模板（基于延迟自动选择）
  url-test-group: &URL_TEST_GROUP_BASE
    type: url-test
    url: "https://www.gstatic.com/generate_204"
    interval: 120
    tolerance: 50
    timeout: 500
    expected-status: 204
    include-all: true

  # 应用策略模板（Smart 优先）
  application-policy: &APPLICATION_POLICY_BASE
    type: select
    hidden: false
    proxies:
      - Smart
      - Hong Kong
      - Taiwan
      - Japan
      - United States
      - Singapore
      - Others
      - IPLC
      - Game
      - Select
      - DIRECT

  # 应用策略模板（DIRECT 优先）
  application-policy-direct-first: &APPLICATION_POLICY_DIRECT_FIRST
    type: select
    hidden: false
    proxies:
      - DIRECT
      - Smart
      - Hong Kong
      - Taiwan
      - Japan
      - United States
      - Singapore
      - Others
      - IPLC
      - Game
      - Select

  # 应用策略模板（AI 无限流量）
  application-policy-ai-unlimited: &APPLICATION_POLICY_AI_UNLIMITED
    type: select
    hidden: false
    proxies:
      - United States
      - Singapore
      - Japan
      - Select

# ------------------------------------------------------------\n# 扩展：规则提供者模板
# x- 前缀表示用户自定义扩展（非 Mihomo 原生配置）
# ------------------------------------------------------------
x-rule-provider-base: &RULE_PROVIDER_BASE
  behavior: "classical" # 规则行为类型
  type: http # 通过 HTTP 获取规则
  interval: 86400 # 更新间隔：24 小时
# endregion

# region 代理配置
# ============================================================
# 代理配置
# ============================================================

# ------------------------------------------------------------\n# 代理组配置
# ------------------------------------------------------------
proxy-groups:
  # ==================== 核心代理组 ====================
  - { name: PROXY, <<: *APPLICATION_POLICY_BASE, type: select }
  - { name: FINAL, <<: *APPLICATION_POLICY_DIRECT_FIRST, type: select }

  # 智能选择（从地区组自动故障转移）
  - name: Smart
    <<: *FALLBACK_GROUP_BASE
    proxies: [Hong Kong, Taiwan, Japan, United States, Singapore, Others]

  # 手动选择
  - { name: Select, <<: *PROXY_GROUP_BASE }

  # ==================== 应用专用代理组 ====================
  # 搜索和生产力工具
  - { name: Google, <<: *APPLICATION_POLICY_BASE }
  - { name: Duckduckgo, <<: *APPLICATION_POLICY_BASE }

  # 社交媒体和通信
  - { name: Telegram, <<: *APPLICATION_POLICY_BASE }
  - { name: Twitter, <<: *APPLICATION_POLICY_BASE }

  # 开发和技术
  - { name: Docker, <<: *APPLICATION_POLICY_BASE }
  - { name: Github, <<: *APPLICATION_POLICY_BASE }
  - { name: SourceForge, <<: *APPLICATION_POLICY_BASE }

  # 流媒体和娱乐
  - { name: YouTube, <<: *APPLICATION_POLICY_BASE }
  - { name: Netflix, <<: *APPLICATION_POLICY_BASE, hidden: true }
  - { name: Spotify, <<: *APPLICATION_POLICY_BASE }
  - { name: Plex, <<: *APPLICATION_POLICY_BASE }

  # AI 服务
  - { name: AI Services, <<: *APPLICATION_POLICY_AI_UNLIMITED }

  # Apple 生态
  - { name: Apple Services, <<: *APPLICATION_POLICY_DIRECT_FIRST }

  # ==================== 地区节点组 ====================
  - { name: Hong Kong, <<: *URL_TEST_GROUP_BASE, filter: *HONG_KONG_KEYWORDS }
  - { name: Taiwan, <<: *URL_TEST_GROUP_BASE, filter: *TAIWAN_KEYWORDS }
  - { name: Japan, <<: *URL_TEST_GROUP_BASE, filter: *JAPAN_KEYWORDS }
  - {
      name: United States,
      <<: *URL_TEST_GROUP_BASE,
      filter: *UNITED_STATES_KEYWORDS,
    }
  - { name: Singapore, <<: *URL_TEST_GROUP_BASE, filter: *SINGAPORE_KEYWORDS }
  - name: Others
    type: url-test
    url: "https://www.gstatic.com/generate_204"
    interval: 120
    tolerance: 50
    timeout: 500
    expected-status: 204
    exclude-filter: "HK|TW|JP|US|SG|IPLC|Game"
    include-all: true

  # ==================== 特殊用途组 ====================
  - name: IPLC
    type: fallback
    url: "https://www.gstatic.com/generate_204"
    interval: 120
    timeout: 500
    expected-status: 204
    filter: "IPLC"
    include-all: true
    fallback-filter:
      retry: 2
      timeout: 500
      health-check:
        enable: true
        interval: 120
        unhealthy_threshold: 2
        healthy_threshold: 2
        http:
          - url: "https://www.gstatic.com/generate_204"
            method: GET
            expected-status: 204
            timeout: 500
  - { name: Game, <<: *PROXY_GROUP_BASE, hidden: true, filter: *GAME_KEYWORDS }
# endregion

# region 路由规则
# ============================================================
# 路由规则
# ============================================================

# ------------------------------------------------------------\n# 规则提供者
# ------------------------------------------------------------
rule-providers:
  # 开发和生产力工具
  Docker:
    <<: *RULE_PROVIDER_BASE
    url: "https://fastly.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/Docker/Docker.yaml"
    path: ./rule-providers/docker.yaml

  Duckduckgo:
    <<: *RULE_PROVIDER_BASE
    url: "https://fastly.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/Duckduckgo/Duckduckgo.yaml"
    path: ./rule-providers/duckduckgo.yaml

  SourceForge:
    <<: *RULE_PROVIDER_BASE
    url: "https://fastly.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/SourceForge/SourceForge.yaml"
    path: ./rule-providers/sourceforge.yaml

  # AI 服务
  OpenAI:
    <<: *RULE_PROVIDER_BASE
    url: "https://fastly.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/OpenAI/OpenAI.yaml"
    path: ./rule-providers/open-ai.yaml

  BardAI:
    <<: *RULE_PROVIDER_BASE
    url: "https://fastly.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/BardAI/BardAI.yaml"
    path: ./rule-providers/bard-ai.yaml

  Claude:
    <<: *RULE_PROVIDER_BASE
    url: "https://fastly.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/Claude/Claude.yaml"
    path: ./rule-providers/claude.yaml

  Gemini:
    <<: *RULE_PROVIDER_BASE
    url: "https://fastly.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/Gemini/Gemini.yaml"
    path: ./rule-providers/gemini.yaml

  # 通信工具
  Telegram:
    <<: *RULE_PROVIDER_BASE
    url: "https://fastly.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/Telegram/Telegram.yaml"
    path: ./rule-providers/telegram.yaml

  # 地理 IP 列表
  ChinaIPs:
    <<: *RULE_PROVIDER_BASE
    url: "https://fastly.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/ChinaIPs/ChinaIPs_IP.yaml"
    path: ./rule-providers/china-ips.yaml

  ChinaDomains:
    <<: *RULE_PROVIDER_BASE
    url: "https://fastly.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/China/China_Domain.yaml"
    path: ./rule-providers/china-domains.yaml

  # 媒体元数据服务
  TMDB:
    <<: *RULE_PROVIDER_BASE
    url: "https://fastly.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/Tmdb/Tmdb.yaml"
    path: ./rule-providers/tmdb.yaml

  IMDB:
    <<: *RULE_PROVIDER_BASE
    url: "https://fastly.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/IMDB/IMDB.yaml"
    path: ./rule-providers/imdb.yaml

  # Apple 服务
  AppStore:
    <<: *RULE_PROVIDER_BASE
    url: "https://fastly.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/AppStore/AppStore.yaml"
    path: ./rule-providers/app-store.yaml

  Apple:
    <<: *RULE_PROVIDER_BASE
    url: "https://fastly.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/Apple/Apple.yaml"
    path: ./rule-providers/apple.yaml

  iCloud:
    <<: *RULE_PROVIDER_BASE
    url: "https://fastly.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/iCloud/iCloud.yaml"
    path: ./rule-providers/icloud.yaml

  # ACL4SSR 规则提供者（为实现 ACL4SSR 功能）
  BanAD:
    <<: *RULE_PROVIDER_BASE
    url: "https://fastly.jsdelivr.net/gh/ACL4SSR/ACL4SSR@master/Clash/BanAD.list"
    path: ./ruleset/ban-ad.list

  BanProgramAD:
    <<: *RULE_PROVIDER_BASE
    url: "https://fastly.jsdelivr.net/gh/ACL4SSR/ACL4SSR@master/Clash/BanProgramAD.list"
    path: ./ruleset/ban-program-ad.list

  ProxyGFWlist:
    <<: *RULE_PROVIDER_BASE
    url: "https://fastly.jsdelivr.net/gh/ACL4SSR/ACL4SSR@master/Clash/ProxyGFWlist.list"
    path: ./ruleset/proxy-gfw-list.list

# ------------------------------------------------------------\n# 路由规则（从上到下优先级）
# ------------------------------------------------------------
rules:
  # ==================== 网络基础 ====================
  # 本地网络 - 始终直连
  - GEOIP,lan,DIRECT,no-resolve
  - GEOIP,private,DIRECT,no-resolve

  # ==================== 国内服务 ====================
  # 中国特定服务（Microsoft、Apple、Steam、游戏）- 直连
  - GEOSITE,microsoft@cn,DIRECT
  - GEOSITE,apple-cn,DIRECT
  - GEOSITE,steam@cn,DIRECT
  - GEOSITE,category-games@cn,DIRECT

  # AdGuard DNS（必须使用代理才能进行广告拦截）
  - DOMAIN-SUFFIX,adguard-dns.com,PROXY
  - DOMAIN-SUFFIX,dns.adguard.com,PROXY

  # ==================== 广告拦截 ====================
  - RULE-SET,BanAD,REJECT
  - RULE-SET,BanProgramAD,REJECT

  # ==================== 媒体元数据服务 ====================
  - RULE-SET,TMDB,Plex
  - RULE-SET,IMDB,Plex

  # ==================== AI 服务 ====================
  - RULE-SET,OpenAI,AI Services
  - RULE-SET,BardAI,AI Services
  - RULE-SET,Gemini,AI Services
  - RULE-SET,Claude,AI Services

  # ==================== 开发工具 ====================
  - RULE-SET,Docker,Docker
  - RULE-SET,SourceForge,SourceForge
  - GEOSITE,github,Github

  # ==================== 搜索引擎 ====================
  - GEOSITE,google,Google
  - RULE-SET,Duckduckgo,Duckduckgo

  # ==================== 社交媒体和通信 ====================
  - RULE-SET,Telegram,Telegram
  - GEOSITE,twitter,Twitter
  - GEOSITE,facebook,PROXY
  - GEOSITE,instagram,PROXY
  - GEOSITE,reddit,PROXY
  - GEOSITE,discord,PROXY
  - GEOSITE,whatsapp,PROXY
  - GEOSITE,tiktok,PROXY

  # ==================== 流媒体服务 ====================
  - GEOSITE,youtube,YouTube
  - GEOSITE,netflix,Netflix
  - GEOSITE,spotify,Spotify
  - GEOSITE,disney,PROXY
  - GEOSITE,hbo,PROXY
  - GEOSITE,twitch,PROXY

  # ==================== Apple 服务 ====================
  - RULE-SET,Apple,Apple Services
  - RULE-SET,AppStore,Apple Services
  - RULE-SET,iCloud,Apple Services

  # ==================== 代理规则 ====================
  - RULE-SET,ProxyGFWlist,PROXY

  # ==================== 中国路由 ====================
  # 所有中国流量使用直连（不走代理）
  - RULE-SET,ChinaDomains,DIRECT
  - RULE-SET,ChinaIPs,DIRECT
  - GEOSITE,CN,DIRECT

  # ==================== 国际路由 ====================
  # 非中国地区使用智能路由
  - GEOSITE,geolocation-!cn,PROXY

  # ==================== GeoIP 路由 ====================
  - GEOIP,google,Google
  - GEOIP,netflix,Netflix
  - GEOIP,telegram,Telegram
  - GEOIP,twitter,Twitter
  - GEOIP,facebook,PROXY
  - GEOIP,CN,DIRECT

  # ==================== 最终兜底规则 ====================
  # 未匹配的流量进入 FINAL 组
  - MATCH,FINAL
# endregion
